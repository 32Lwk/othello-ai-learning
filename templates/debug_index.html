<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>åŒ»è–¬å“ç›¸è«‡AI - ãƒ‡ãƒãƒƒã‚°ãƒ»ä¿å®ˆç”»é¢</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .content {
            padding: 20px;
        }
        .section {
            margin-bottom: 30px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .section-header {
            background: #34495e;
            color: white;
            padding: 15px;
            font-weight: bold;
        }
        .section-content {
            padding: 20px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .status-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        .status-card h3 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 16px;
        }
        .status-item {
            margin: 5px 0;
            font-size: 14px;
        }
        .status-success {
            color: #28a745;
        }
        .status-error {
            color: #dc3545;
        }
        .status-warning {
            color: #ffc107;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button-danger {
            background: #dc3545;
        }
        .button-danger:hover {
            background: #c82333;
        }
        .button-success {
            background: #28a745;
        }
        .button-success:hover {
            background: #218838;
        }
        .logs-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background: #f8f9fa;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
        .log-info {
            background: #d1ecf1;
            border-left: 3px solid #17a2b8;
        }
        .log-error {
            background: #f8d7da;
            border-left: 3px solid #dc3545;
        }
        .log-warning {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: #f8f9fa;
            border-left: 3px solid #007bff;
        }
        .test-success {
            background: #d4edda;
            border-left-color: #28a745;
        }
        .test-error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .data-table th,
        .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background: #f2f2f2;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }
        .connection-connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .connection-disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .new-log {
            animation: highlight 2s ease-out;
        }
        @keyframes highlight {
            0% { background-color: #fff3cd; }
            100% { background-color: transparent; }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">
        <div id="connection-text">æ¥ç¶šä¸­...</div>
        <div id="last-update-time" style="font-size: 10px; margin-top: 2px; opacity: 0.8;">æœ€çµ‚å–å¾—: --:--:--</div>
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ”§ åŒ»è–¬å“ç›¸è«‡AI - ãƒ‡ãƒãƒƒã‚°ãƒ»ä¿å®ˆç”»é¢</h1>
            <p>ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®ç¢ºèªã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°å¯¾å¿œï¼‰</p>
        </div>
        
        <div class="content">
            <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ -->
            <div class="section">
                <div class="section-header">ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</div>
                <div class="section-content">
                    <div id="status-content">
                        <div class="loading">çŠ¶æ…‹ã‚’ç¢ºèªä¸­...</div>
                    </div>
                </div>
            </div>
            
            <!-- ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ -->
            <div class="section">
                <div class="section-header">ğŸ§ª ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½</div>
                <div class="section-content">
                    <button class="button" onclick="testCSV()">CSVãƒ•ã‚¡ã‚¤ãƒ«ãƒ†ã‚¹ãƒˆ</button>
                    <button class="button" onclick="testAPI()">OpenAI APIãƒ†ã‚¹ãƒˆ</button>
                    <button class="button" onclick="detailedAPITest()">è©³ç´°APIãƒ†ã‚¹ãƒˆ</button>
                    <button class="button button-success" onclick="reloadCSV()">CSVå†èª­ã¿è¾¼ã¿</button>
                    <div id="test-results"></div>
                </div>
            </div>
            
            <!-- ãƒ­ã‚° -->
            <div class="section">
                <div class="section-header">ğŸ“ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</div>
                <div class="section-content">
                    <button class="button" onclick="refreshLogs()">ãƒ­ã‚°ã‚’æ›´æ–°</button>
                    <button class="button button-danger" onclick="clearLogs()">ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
                    <button class="button button-success" onclick="exportLogs()">ãƒ­ã‚°ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <div class="logs-container" id="logs-content">
                        <div class="loading">ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç›£è¦– -->
            <div class="section">
                <div class="section-header">ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç›£è¦–</div>
                <div class="section-content">
                    <button class="button" onclick="refreshNetworkLogs()">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ­ã‚°æ›´æ–°</button>
                    <div class="logs-container" id="network-logs-content">
                        <div class="loading">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆ -->
            <div class="section">
                <div class="section-header">ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆ</div>
                <div class="section-content">
                    <button class="button" onclick="refreshPerformanceStats()">çµ±è¨ˆæ›´æ–°</button>
                    <button class="button button-danger" onclick="resetPerformanceStats()">çµ±è¨ˆãƒªã‚»ãƒƒãƒˆ</button>
                    <div id="performance-stats-content">
                        <div class="loading">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ -->
            <div class="section">
                <div class="section-header">ğŸ“Š ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³</div>
                <div class="section-content">
                    <div id="main-status">
                        <div class="loading">ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã®æƒ…å ±ã‚’å–å¾—ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆ -->
            <div class="section">
                <div class="section-header">ğŸ“ˆ ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆ</div>
                <div class="section-content">
                    <div id="main-performance">
                        <div class="loading">ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æƒ…å ±ã‚’å–å¾—ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆ é€šä¿¡ãƒ­ã‚° -->
            <div class="section">
                <div class="section-header">ğŸ“ ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆ é€šä¿¡ãƒ­ã‚°</div>
                <div class="section-content">
                    <div id="main-logs">
                        <div class="loading">ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã®ãƒ­ã‚°ã‚’å–å¾—ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ãƒ»ãƒ—ãƒ­ã‚»ã‚¹æƒ…å ± -->
            <div class="section">
                <div class="section-header">ğŸ–¥ï¸ ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ãƒ»ãƒ—ãƒ­ã‚»ã‚¹æƒ…å ±</div>
                <div class="section-content">
                    <button class="button" onclick="refreshServerLogs()">ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°æ›´æ–°</button>
                    <div id="server-logs">
                        <div class="loading">ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚’å–å¾—ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ç›£è¦– -->
            <div class="section">
                <div class="section-header">ğŸ’» ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ç›£è¦–</div>
                <div class="section-content">
                    <button class="button" onclick="refreshSystemResources()">ãƒªã‚½ãƒ¼ã‚¹çŠ¶æ³æ›´æ–°</button>
                    <div id="system-resources">
                        <div class="loading">ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ã‚’å–å¾—ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆ ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ± -->
            <div class="section">
                <div class="section-header">ğŸ‘¥ ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆ ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±</div>
                <div class="section-content">
                    <button class="button" onclick="refreshMainSessions()">ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±æ›´æ–°</button>
                    <div id="main-sessions">
                        <div class="loading">ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- AIåˆ¶å¾¡ãƒ»æ‰‹å‹•è¿”ä¿¡ -->
            <div class="section">
                <div class="section-header">ğŸ¤– AIåˆ¶å¾¡ãƒ»æ‰‹å‹•è¿”ä¿¡</div>
                <div class="section-content">
                    <div style="margin-bottom: 20px;">
                        <h4>AIè‡ªå‹•å¿œç­”åˆ¶å¾¡</h4>
                        <button id="ai-on-btn" class="button button-success" onclick="setAIMode('on')">AIè‡ªå‹•å¿œç­”ON</button>
                        <button id="ai-off-btn" class="button button-danger" onclick="setAIMode('off')">AIè‡ªå‹•å¿œç­”OFF</button>
                        <span id="ai-status" style="margin-left: 10px; font-weight: bold;">çŠ¶æ…‹ç¢ºèªä¸­...</span>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4>æ‰‹å‹•è¿”ä¿¡å¾…ã¡ã‚­ãƒ¥ãƒ¼</h4>
                        <button class="button" onclick="refreshManualReplyQueue()">ã‚­ãƒ¥ãƒ¼æ›´æ–°</button>
                        <div id="manual-reply-queue">
                            <div class="loading">æ‰‹å‹•è¿”ä¿¡ã‚­ãƒ¥ãƒ¼ã‚’å–å¾—ä¸­...</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4>æ‰‹å‹•è¿”ä¿¡é€ä¿¡</h4>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="reply-session-select" style="padding: 5px; min-width: 200px;">
                                <option value="">ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠ</option>
                            </select>
                            <input type="text" id="reply-message-input" placeholder="è¿”ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" style="flex: 1; padding: 5px;">
                            <button class="button button-success" onclick="sendManualReply()">é€ä¿¡</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <button class="btn btn-primary" onclick="window.open('/admin', '_blank')">ç®¡ç†è€…ç”¨ãƒãƒ£ãƒƒãƒˆç›£è¦–ãƒ»æ‰‹å‹•è¿”ä¿¡ãƒšãƒ¼ã‚¸ï¼ˆ/adminï¼‰ã¸</button>
                    </div>
                </div>
            </div>

            <div class="section-header">
                ğŸŸ¢ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¥ç¶šä¸­
                <span id="main-last-update" style="font-size:12px; color:#666; margin-left:10px;"></span>
            </div>
        </div>
    </div>

    <script>
        // Socket.IOæ¥ç¶š
        const socket = io();
        let isConnected = false;

        // æ¥ç¶šçŠ¶æ…‹ã®ç®¡ç†
        socket.on('connect', function() {
            isConnected = true;
            updateConnectionStatus(true);
            console.log('Connected to debug server');
        });

        socket.on('disconnect', function() {
            isConnected = false;
            updateConnectionStatus(false);
            console.log('Disconnected from debug server');
        });

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
        socket.on('debug_log_update', function(data) {
            addNewLog(data.log);
        });

        socket.on('network_log_update', function(data) {
            updateNetworkLogsDisplay(data.logs);
            updatePerformanceStatsDisplay(data.performance_stats);
        });

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            const textElement = document.getElementById('connection-text');
            
            if (statusElement && textElement) {
                if (connected) {
                    statusElement.className = 'connection-status connection-connected';
                    textElement.textContent = 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¥ç¶šä¸­';
                } else {
                    statusElement.className = 'connection-status connection-disconnected';
                    textElement.textContent = 'æ¥ç¶šåˆ‡ã‚Œ';
                }
            }
            
            // æ¥ç¶šçŠ¶æ…‹æ›´æ–°æ™‚ã«ã‚‚æœ€çµ‚å–å¾—æ™‚åˆ»ã‚’æ›´æ–°ï¼ˆå­˜åœ¨ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ja-JP', { hour12: false });
            const lastUpdateElement = document.getElementById('last-update-time');
            if (lastUpdateElement) {
                lastUpdateElement.textContent = `æœ€çµ‚å–å¾—: ${timeStr}`;
            }
        }

        function addNewLog(logEntry) {
            const content = document.getElementById('logs-content');
            if (!content) {
                console.warn('logs-content element not found');
                return;
            }
            
            const logClass = `log-${logEntry.level.toLowerCase()}`;
            const logHtml = `
                <div class="log-entry ${logClass} new-log">
                    <strong>${logEntry.timestamp}</strong> [${logEntry.level}] ${logEntry.message}
                </div>
            `;
            
            // æ–°ã—ã„ãƒ­ã‚°ã‚’å…ˆé ­ã«è¿½åŠ 
            content.insertAdjacentHTML('afterbegin', logHtml);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            setTimeout(() => {
                const newLogElement = content.querySelector('.new-log');
                if (newLogElement) {
                    newLogElement.classList.remove('new-log');
                }
            }, 2000);
        }

        function updateNetworkLogsDisplay(logs) {
            const content = document.getElementById('network-logs-content');
            if (!content) {
                console.warn('network-logs-content element not found');
                return;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã§ãªã„å ´åˆã®å‡¦ç†
            if (!logs) {
                content.innerHTML = '<div class="loading">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ­ã‚°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
                return;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã§ãªã„å ´åˆã¯é…åˆ—ã«å¤‰æ›
            const logsArray = Array.isArray(logs) ? logs : [];
            
            if (logsArray.length === 0) {
                content.innerHTML = '<div class="loading">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            let html = '';
            logsArray.forEach(log => {
                html += `<div class="log-entry">
                    <strong>${log.timestamp}</strong> [${log.status}] ${log.endpoint}<br>
                    <span style="font-size:11px;">${JSON.stringify(log.request_data)}<br>${JSON.stringify(log.response_data)}<br>time: ${log.response_time}s, tokens: ${log.tokens_used}</span>
                </div>`;
            });
            content.innerHTML = html;
            content.scrollTop = content.scrollHeight;
        }

        function updatePerformanceStatsDisplay(stats) {
            renderPerformanceTable(stats);
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.onload = function() {
            checkStatus();
            refreshLogs();
            refreshNetworkLogs();
            refreshPerformanceStats();
            
            // å®šæœŸçš„ãªæ›´æ–°ï¼ˆWebSocketãŒä½¿ãˆãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            setInterval(() => {
                if (!isConnected) {
                    refreshNetworkLogs();
                    refreshPerformanceStats();
                }
            }, 10000);
        };

        // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’ç¢ºèª
        function checkStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    const content = document.getElementById('status-content');
                    if (!data || !data.csv_status) {
                        content.innerHTML = '<div class="test-error">ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: csv_statusãŒå­˜åœ¨ã—ã¾ã›ã‚“</div>';
                        return;
                    }
                    const s = data.csv_status;
                    content.innerHTML = `
                        <table class="data-table">
                            <tr><th>é …ç›®</th><th>å€¤</th></tr>
                            <tr><td>ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</td><td>${new Date().toLocaleString('ja-JP')}</td></tr>
                            <tr><td>èª­ã¿è¾¼ã¿</td><td>${s.success ? 'âœ…' : 'âŒ'}</td></tr>
                            <tr><td>ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</td><td>${s.encoding || ''}</td></tr>
                            <tr><td>è¡Œæ•°</td><td>${s.row_count || 0}</td></tr>
                            <tr><td>åˆ—æ•°</td><td>${s.col_count || 0}</td></tr>
                            <tr><td>åˆ—å</td><td>${s.columns ? s.columns.join(', ') : ''}</td></tr>
                            <tr><td>ãƒ‘ã‚¹</td><td>${s.path || ''}</td></tr>
                            <tr><td>ã‚¨ãƒ©ãƒ¼</td><td>${s.error || ''}</td></tr>
                        </table>
                    `;
                })
                .catch(error => {
                    document.getElementById('status-content').innerHTML = `
                        <div class="test-error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>
                    `;
                });
        }

        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ†ã‚¹ãƒˆ
        function testCSV() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<div class="loading">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ†ã‚¹ãƒˆä¸­...</div>';
            
            fetch('/test_csv')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        results.innerHTML = `<div class="test-error">ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
                    } else {
                        let tableHtml = '<table class="data-table"><thead><tr>';
                        data.stats.column_names.forEach(col => {
                            tableHtml += `<th>${col}</th>`;
                        });
                        tableHtml += '</tr></thead><tbody>';
                        
                        data.sample_data.forEach(row => {
                            tableHtml += '<tr>';
                            data.stats.column_names.forEach(col => {
                                tableHtml += `<td>${row[col] || ''}</td>`;
                            });
                            tableHtml += '</tr>';
                        });
                        tableHtml += '</tbody></table>';
                        
                        results.innerHTML = `
                            <div class="test-success">
                                <h4>CSVãƒ•ã‚¡ã‚¤ãƒ«ãƒ†ã‚¹ãƒˆæˆåŠŸ</h4>
                                <p>ç·è¡Œæ•°: ${data.stats.total_rows}</p>
                                <p>ç·åˆ—æ•°: ${data.stats.total_columns}</p>
                                <h5>ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€åˆã®5è¡Œï¼‰:</h5>
                                ${tableHtml}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    results.innerHTML = `<div class="test-error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                });
        }

        // OpenAI APIã‚’ãƒ†ã‚¹ãƒˆ
        function testAPI() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<div class="loading">OpenAI APIã‚’ãƒ†ã‚¹ãƒˆä¸­...</div>';
            
            fetch('/test_api')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        results.innerHTML = `<div class="test-error">ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
                    } else {
                        results.innerHTML = `
                            <div class="test-success">
                                <h4>OpenAI APIãƒ†ã‚¹ãƒˆæˆåŠŸ</h4>
                                <p>ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${data.response}</p>
                                <p>å¿œç­”æ™‚é–“: ${data.response_time}ç§’</p>
                                <p>ãƒ¢ãƒ‡ãƒ«: ${data.model}</p>
                                ${data.usage ? `<p>ä½¿ç”¨é‡: ${JSON.stringify(data.usage)}</p>` : ''}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    results.innerHTML = `<div class="test-error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                });
        }

        // è©³ç´°APIãƒ†ã‚¹ãƒˆ
        function detailedAPITest() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<div class="loading">è©³ç´°APIãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...</div>';
            
            fetch('/detailed_api_test')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        results.innerHTML = `<div class="test-error">ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
                    } else {
                        let testResultsHtml = '';
                        data.test_results.forEach(test => {
                            testResultsHtml += `
                                <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                    <h5>${test.test_type}</h5>
                                    <p><strong>å…¥åŠ›:</strong> ${test.input}</p>
                                    <p><strong>å¿œç­”æ™‚é–“:</strong> ${test.response_time}ç§’</p>
                                    <p><strong>ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡:</strong> ${test.usage ? test.usage.total_tokens : 'N/A'}</p>
                                    <p><strong>ãƒ¬ã‚¹ãƒãƒ³ã‚¹:</strong></p>
                                    <pre style="background: #f5f5f5; padding: 10px; border-radius: 3px; font-size: 12px; overflow-x: auto;">${test.response}</pre>
                                </div>
                            `;
                        });
                        
                        results.innerHTML = `
                            <div class="test-success">
                                <h4>è©³ç´°APIãƒ†ã‚¹ãƒˆå®Œäº†</h4>
                                <p><strong>ç·ãƒ†ã‚¹ãƒˆæ•°:</strong> ${data.summary.total_tests}</p>
                                <p><strong>ç·å¿œç­”æ™‚é–“:</strong> ${data.summary.total_response_time}ç§’</p>
                                <p><strong>å¹³å‡å¿œç­”æ™‚é–“:</strong> ${data.summary.average_response_time}ç§’</p>
                                <p><strong>ç·ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡:</strong> ${data.summary.total_tokens_used}</p>
                                <h5>ãƒ†ã‚¹ãƒˆçµæœè©³ç´°:</h5>
                                ${testResultsHtml}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    results.innerHTML = `<div class="test-error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                });
        }

        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†èª­ã¿è¾¼ã¿
        function reloadCSV() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<div class="loading">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†èª­ã¿è¾¼ã¿ä¸­...</div>';
            
            fetch('/reload_csv', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        results.innerHTML = `<div class="test-error">ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
                    } else {
                        results.innerHTML = `
                            <div class="test-success">
                                <h4>CSVå†èª­ã¿è¾¼ã¿æˆåŠŸ</h4>
                                <p>${data.message}</p>
                                <p>èª­ã¿è¾¼ã¾ã‚ŒãŸè¡Œæ•°: ${data.rows}</p>
                            </div>
                        `;
                        // çŠ¶æ…‹ã‚’æ›´æ–°
                        checkStatus();
                    }
                })
                .catch(error => {
                    results.innerHTML = `<div class="test-error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                });
        }

        // ãƒ­ã‚°ã‚’æ›´æ–°
        function refreshLogs() {
            fetch('/logs')
                .then(response => response.json())
                .then(logs => {
                    const content = document.getElementById('logs-content');
                    if (logs.length === 0) {
                        content.innerHTML = '<div class="loading">ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                        return;
                    }
                    
                    let logsHtml = '';
                    logs.forEach(log => {
                        const logClass = `log-${log.level.toLowerCase()}`;
                        logsHtml += `
                            <div class="log-entry ${logClass}">
                                <strong>${log.timestamp}</strong> [${log.level}] ${log.message}
                            </div>
                        `;
                    });
                    content.innerHTML = logsHtml;
                    content.scrollTop = content.scrollHeight;
                })
                .catch(error => {
                    document.getElementById('logs-content').innerHTML = `
                        <div class="log-error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>
                    `;
                });
        }

        // ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢
        function clearLogs() {
            if (confirm('ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                fetch('/clear_logs', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        refreshLogs();
                        alert(data.message);
                    })
                    .catch(error => {
                        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
                    });
            }
        }

        // ãƒ­ã‚°ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportLogs() {
            fetch('/export_logs')
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                })
                .catch(error => {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
                });
        }

        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ­ã‚°ã‚’æ›´æ–°
        function refreshNetworkLogs() {
            fetch('/network_logs')
                .then(res => res.json())
                .then(data => {
                    updateNetworkLogsDisplay(data);
                    updateTimestamp('network-logs-update');
                })
                .catch(error => {
                    const content = document.getElementById('network-logs-content');
                    if (content) {
                        content.innerHTML = `<div class="test-error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    }
                    updateTimestamp('network-logs-update');
                });
        }

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆã‚’æ›´æ–°
        function refreshPerformanceStats() {
            fetch('/performance_stats')
                .then(res => res.json())
                .then(data => {
                    renderPerformanceTable(data);
                    updateTimestamp('performance-stats-update');
                })
                .catch(error => {
                    const content = document.getElementById('performance-stats-content');
                    if (content) {
                        content.innerHTML = `<div class="test-error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    }
                    updateTimestamp('performance-stats-update');
                });
        }

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆ
        function resetPerformanceStats() {
            fetch('/reset_performance_stats', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    refreshPerformanceStats();
                    add_debug_log("ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
                })
                .catch(error => {
                    console.error('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
                });
        }

        function updateTimestamp(elementId) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ja-JP', { hour12: false });
            
            // æŒ‡å®šã•ã‚ŒãŸè¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æ›´æ–°
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = `æœ€çµ‚å–å¾—: ${timeStr}`;
            }
            
            // å³ä¸Šã®æœ€çµ‚å–å¾—æ™‚åˆ»ã‚‚æ›´æ–°ï¼ˆå­˜åœ¨ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
            const lastUpdateElement = document.getElementById('last-update-time');
            if (lastUpdateElement) {
                lastUpdateElement.textContent = `æœ€çµ‚å–å¾—: ${timeStr}`;
            }
        }

        function fetchMainStatus() {
            fetch('/api/main_status')
              .then(res => res.json())
              .then(data => {
                renderMainStatusTable(data);
                updateTimestamp('main-last-update');
              })
              .catch(error => {
                const content = document.getElementById('main-status');
                if (content) {
                    content.innerHTML = `<div class="test-error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                }
                updateTimestamp('main-last-update');
              });
        }

        function fetchMainPerformance() {
            fetch('/api/main_performance')
              .then(res => res.json())
              .then(data => {
                renderMainPerformanceTable(data);
                updateTimestamp('main-last-update');
              })
              .catch(error => {
                const content = document.getElementById('main-performance');
                if (content) {
                    content.innerHTML = `<div class="test-error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                }
                updateTimestamp('main-last-update');
              });
        }

        function fetchMainLogs() {
            fetch('/api/main_logs')
              .then(res => res.json())
              .then(data => {
                renderMainLogsTable(data);
                updateTimestamp('main-last-update');
              })
              .catch(error => {
                const content = document.getElementById('main-logs');
                if (content) {
                    content.innerHTML = `<div class="test-error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                }
                updateTimestamp('main-last-update');
              });
        }

        function fetchTestStatus() {
            fetch('/api/status')
              .then(res => res.json())
              .then(data => {
                updateTimestamp('test-last-update');
              })
              .catch(error => {
                console.log('ãƒ†ã‚¹ãƒˆã‚µã‚¤ãƒˆçŠ¶æ…‹å–å¾—ã‚¨ãƒ©ãƒ¼:', error.message);
                updateTimestamp('test-last-update');
              });
        }

        // 1ç§’ã”ã¨ã®è‡ªå‹•æ›´æ–°ã‚’è¨­å®š
        setInterval(checkStatus, 1000);
        setInterval(refreshPerformanceStats, 1000);
        setInterval(refreshNetworkLogs, 1000);
        setInterval(() => {
            fetch('/logs')
                .then(res => res.json())
                .then(data => renderLogsTable(data))
                .catch(e => {
                    const content = document.getElementById('logs-content');
                    if (content) {
                        content.innerHTML = '<div class="test-error">å–å¾—å¤±æ•—</div>';
                    }
                });
        }, 1000);
        setInterval(fetchMainStatus, 1000);
        setInterval(fetchMainPerformance, 1000);
        setInterval(fetchMainLogs, 1000);
        
        // åˆæœŸèª­ã¿è¾¼ã¿
        checkStatus();
        refreshPerformanceStats();
        refreshNetworkLogs();
        fetch('/logs')
            .then(res => res.json())
            .then(data => renderLogsTable(data))
            .catch(e => {
                const content = document.getElementById('logs-content');
                if (content) {
                    content.innerHTML = '<div class="test-error">å–å¾—å¤±æ•—</div>';
                }
            });
        fetchMainStatus();
        fetchMainPerformance();
        fetchMainLogs();

        function renderMainStatusTable(data) {
            const content = document.getElementById('main-status');
            if (!content) {
                console.warn('main-status element not found');
                return;
            }
            
            if (!data || !data.csv_load_status) {
                content.innerHTML = '<div class="test-error">ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
                return;
            }
            const s = data.csv_load_status;
            content.innerHTML = `
                <table class="data-table">
                    <tr><th>é …ç›®</th><th>å€¤</th></tr>
                    <tr><td>ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</td><td>${data.timestamp || ''}</td></tr>
                    <tr><td>èª­ã¿è¾¼ã¿</td><td>${s.success ? 'âœ…' : 'âŒ'}</td></tr>
                    <tr><td>ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</td><td>${s.encoding || ''}</td></tr>
                    <tr><td>è¡Œæ•°</td><td>${s.row_count || 0}</td></tr>
                    <tr><td>åˆ—æ•°</td><td>${s.col_count || 0}</td></tr>
                    <tr><td>åˆ—å</td><td>${s.columns ? s.columns.join(', ') : ''}</td></tr>
                    <tr><td>ãƒ‘ã‚¹</td><td>${s.path || ''}</td></tr>
                    <tr><td>ã‚¨ãƒ©ãƒ¼</td><td>${s.error || ''}</td></tr>
                </table>
            `;
        }

        function renderMainPerformanceTable(data) {
            const content = document.getElementById('main-performance');
            if (!content) {
                console.warn('main-performance element not found');
                return;
            }
            
            if (!data) {
                content.innerHTML = '<div class="test-error">ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‹ã‚‰ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
                return;
            }
            content.innerHTML = `
                <table class="data-table">
                    <tr><th>é …ç›®</th><th>å€¤</th></tr>
                    <tr><td>ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</td><td>${new Date().toLocaleString('ja-JP')}</td></tr>
                    <tr><td>ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°</td><td>${data.total_requests || 0}</td></tr>
                    <tr><td>æˆåŠŸãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°</td><td>${data.successful_requests || 0}</td></tr>
                    <tr><td>å¤±æ•—ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°</td><td>${data.failed_requests || 0}</td></tr>
                    <tr><td>å¹³å‡å¿œç­”æ™‚é–“</td><td>${data.average_response_time || 0} ç§’</td></tr>
                    <tr><td>ç·ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡</td><td>${data.total_tokens_used || 0}</td></tr>
                    <tr><td>æœ¬æ—¥APIã‚³ãƒ¼ãƒ«æ•°</td><td>${data.api_calls_today || 0}</td></tr>
                </table>
            `;
        }

        function renderMainLogsTable(data) {
            const content = document.getElementById('main-logs');
            if (!content) {
                console.warn('main-logs element not found');
                return;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã§ãªã„å ´åˆã®å‡¦ç†
            if (!data) {
                content.innerHTML = '<div class="loading">ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã®ãƒ­ã‚°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
                return;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã§ãªã„å ´åˆã¯é…åˆ—ã«å¤‰æ›
            const logsArray = Array.isArray(data) ? data : [];
            
            if (logsArray.length === 0) {
                content.innerHTML = '<div class="loading">ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã®ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            let html = '<table class="data-table"><tr><th>æ™‚åˆ»</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ</th><th>å¿œç­”æ™‚é–“</th><th>ãƒˆãƒ¼ã‚¯ãƒ³</th></tr>';
            logsArray.forEach(log => {
                html += `<tr>
                    <td>${log.timestamp || ''}</td>
                    <td>${log.status || ''}</td>
                    <td>${log.endpoint || ''}</td>
                    <td>${log.response_time || 0}s</td>
                    <td>${log.tokens_used || 0}</td>
                </tr>`;
            });
            html += '</table>';
            content.innerHTML = html;
        }

        function renderLogsTable(logs) {
            const content = document.getElementById('logs-content');
            if (!content) {
                console.warn('logs-content element not found');
                return;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã§ãªã„å ´åˆã®å‡¦ç†
            if (!logs) {
                content.innerHTML = '<div class="loading">ãƒ­ã‚°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
                return;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã§ãªã„å ´åˆã¯é…åˆ—ã«å¤‰æ›
            const logsArray = Array.isArray(logs) ? logs : [];
            
            if (logsArray.length === 0) {
                content.innerHTML = '<div class="loading">ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            let html = '<table class="data-table"><tr><th>æ™‚åˆ»</th><th>ãƒ¬ãƒ™ãƒ«</th><th>å†…å®¹</th></tr>';
            logsArray.forEach(log => {
                html += `<tr>
                    <td>${log.timestamp || ''}</td>
                    <td>${log.level || ''}</td>
                    <td>${log.message || ''}</td>
                </tr>`;
            });
            html += '</table>';
            content.innerHTML = html;
        }

        function renderPerformanceTable(stats) {
            const content = document.getElementById('performance-stats-content');
            if (!content) {
                console.warn('performance-stats-content element not found');
                return;
            }
            
            if (!stats) {
                content.innerHTML = '<div class="test-error">ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼</div>';
                return;
            }
            content.innerHTML = `
                <table class="data-table">
                    <tr><th>é …ç›®</th><th>å€¤</th></tr>
                    <tr><td>ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</td><td>${new Date().toLocaleString('ja-JP')}</td></tr>
                    <tr><td>ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°</td><td>${stats.total_requests || 0}</td></tr>
                    <tr><td>æˆåŠŸãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°</td><td>${stats.successful_requests || 0}</td></tr>
                    <tr><td>å¤±æ•—ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°</td><td>${stats.failed_requests || 0}</td></tr>
                    <tr><td>å¹³å‡å¿œç­”æ™‚é–“</td><td>${stats.average_response_time || 0} ç§’</td></tr>
                    <tr><td>ç·ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡</td><td>${stats.total_tokens_used || 0}</td></tr>
                    <tr><td>æœ¬æ—¥APIã‚³ãƒ¼ãƒ«æ•°</td><td>${stats.api_calls_today || 0}</td></tr>
                </table>
            `;
        }

        // æ–°ã—ã„ç›£è¦–æ©Ÿèƒ½ã®é–¢æ•°
        function refreshServerLogs() {
            fetch('/api/server_logs')
                .then(res => res.json())
                .then(data => {
                    renderServerLogs(data);
                })
                .catch(error => {
                    const content = document.getElementById('server-logs');
                    if (content) {
                        content.innerHTML = `<div class="test-error">ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    }
                });
        }

        function refreshSystemResources() {
            fetch('/api/system_resources')
                .then(res => res.json())
                .then(data => {
                    renderSystemResources(data);
                })
                .catch(error => {
                    const content = document.getElementById('system-resources');
                    if (content) {
                        content.innerHTML = `<div class="test-error">ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    }
                });
        }

        function refreshMainSessions() {
            fetch('/api/main_sessions')
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }
                    return res.json();
                })
                .then(data => {
                    renderMainSessions(data);
                })
                .catch(error => {
                    const content = document.getElementById('main-sessions');
                    if (content) {
                        const errorMsg = error.message || 'Unknown error';
                        const errorDetails = error.details || '';
                        content.innerHTML = `
                            <div class="test-error">
                                <strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:</strong> ${errorMsg}
                                ${errorDetails ? `<br><small>è©³ç´°: ${errorDetails}</small>` : ''}
                                <br><small>ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆï¼ˆlocalhost:5000ï¼‰ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</small>
                                <br><button onclick="refreshMainSessions()" style="margin-top: 10px; padding: 5px 10px;">ğŸ”„ å†è©¦è¡Œ</button>
                            </div>
                        `;
                    }
                    console.error('Main sessions fetch error:', error);
                });
        }

        function renderServerLogs(data) {
            const content = document.getElementById('server-logs');
            if (!content) {
                console.warn('server-logs element not found');
                return;
            }
            
            if (!data || data.error) {
                content.innerHTML = `<div class="test-error">ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼: ${data?.error || 'Unknown error'}</div>`;
                return;
            }
            
            const process = data.process_info;
            const lastDebugLog = data.last_debug_log;
            const lastNetworkLog = data.last_network_log;
            
            content.innerHTML = `
                <table class="data-table">
                    <tr><th>é …ç›®</th><th>å€¤</th></tr>
                    <tr><td>ãƒ—ãƒ­ã‚»ã‚¹ID</td><td>${process.pid || 'N/A'}</td></tr>
                    <tr><td>ãƒ—ãƒ­ã‚»ã‚¹å</td><td>${process.name || 'N/A'}</td></tr>
                    <tr><td>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</td><td>${process.status || 'N/A'}</td></tr>
                    <tr><td>ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ (RSS)</td><td>${(process.memory_rss / 1024 / 1024).toFixed(2)} MB</td></tr>
                    <tr><td>ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ (VMS)</td><td>${(process.memory_vms / 1024 / 1024).toFixed(2)} MB</td></tr>
                    <tr><td>CPUä½¿ç”¨ç‡</td><td>${process.cpu_percent || 0}%</td></tr>
                    <tr><td>ã‚¹ãƒ¬ãƒƒãƒ‰æ•°</td><td>${process.num_threads || 0}</td></tr>
                    <tr><td>æ¥ç¶šæ•°</td><td>${process.connections || 0}</td></tr>
                    <tr><td>ä½œæˆæ™‚åˆ»</td><td>${process.create_time || 'N/A'}</td></tr>
                    <tr><td>ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°æ•°</td><td>${data.debug_logs_count || 0}</td></tr>
                    <tr><td>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ­ã‚°æ•°</td><td>${data.network_logs_count || 0}</td></tr>
                    <tr><td>æœ€æ–°ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</td><td>${lastDebugLog ? `${lastDebugLog.timestamp} - ${lastDebugLog.message}` : 'ãªã—'}</td></tr>
                    <tr><td>æœ€æ–°ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ­ã‚°</td><td>${lastNetworkLog ? `${lastNetworkLog.timestamp} - ${lastNetworkLog.endpoint}` : 'ãªã—'}</td></tr>
                </table>
            `;
        }

        function renderSystemResources(data) {
            const content = document.getElementById('system-resources');
            if (!content) {
                console.warn('system-resources element not found');
                return;
            }
            
            if (!data || data.error) {
                content.innerHTML = `<div class="test-error">ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼: ${data?.error || 'Unknown error'}</div>`;
                return;
            }
            
            content.innerHTML = `
                <table class="data-table">
                    <tr><th>é …ç›®</th><th>å€¤</th></tr>
                    <tr><td>CPUä½¿ç”¨ç‡</td><td>${data.cpu_percent || 0}%</td></tr>
                    <tr><td>ãƒ¡ãƒ¢ãƒªç·å®¹é‡</td><td>${(data.memory_total / 1024 / 1024 / 1024).toFixed(2)} GB</td></tr>
                    <tr><td>ãƒ¡ãƒ¢ãƒªä½¿ç”¨å¯èƒ½</td><td>${(data.memory_available / 1024 / 1024 / 1024).toFixed(2)} GB</td></tr>
                    <tr><td>ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡</td><td>${data.memory_percent || 0}%</td></tr>
                    <tr><td>ãƒ‡ã‚£ã‚¹ã‚¯ç·å®¹é‡</td><td>${(data.disk_total / 1024 / 1024 / 1024).toFixed(2)} GB</td></tr>
                    <tr><td>ãƒ‡ã‚£ã‚¹ã‚¯ç©ºãå®¹é‡</td><td>${(data.disk_free / 1024 / 1024 / 1024).toFixed(2)} GB</td></tr>
                    <tr><td>ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡</td><td>${data.disk_percent || 0}%</td></tr>
                </table>
            `;
        }

        function renderMainSessions(data) {
            const content = document.getElementById('main-sessions');
            if (!content) {
                console.warn('main-sessions element not found');
                return;
            }
            
            if (!data || data.error) {
                const errorMsg = data?.error || 'Unknown error';
                const errorDetails = data?.details || '';
                content.innerHTML = `
                    <div class="test-error">
                        <strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:</strong> ${errorMsg}
                        ${errorDetails ? `<br><small>è©³ç´°: ${errorDetails}</small>` : ''}
                        <br><small>ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆï¼ˆlocalhost:5000ï¼‰ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</small>
                        <br><button onclick="refreshMainSessions()" style="margin-top: 10px; padding: 5px 10px;">ğŸ”„ å†è©¦è¡Œ</button>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = `
                <table class="data-table">
                    <tr><th>é …ç›®</th><th>å€¤</th></tr>
                    <tr><td>ã‚»ãƒƒã‚·ãƒ§ãƒ³ID</td><td>${data.session_id || 'N/A'}</td></tr>
                    <tr><td>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°</td><td>${data.messages_count || 0}</td></tr>
                    <tr><td>æœ€çµ‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</td><td>${data.last_activity || 'N/A'}</td></tr>
                    <tr><td>ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹</td><td>${data.session_active ? 'âœ…' : 'âŒ'}</td></tr>
                </table>
                ${data.messages && data.messages.length > 0 ? `
                <h4>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´:</h4>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                    ${data.messages.map(msg => `
                        <div style="margin: 5px 0; padding: 5px; background: ${msg.type === 'user' ? '#e3f2fd' : '#f3e5f5'}; border-radius: 3px;">
                            <strong>${msg.type === 'user' ? 'ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼' : 'ğŸ¤– ãƒœãƒƒãƒˆ'}</strong>: ${msg.content}
                        </div>
                    `).join('')}
                </div>
                ` : '<p>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>'}
            `;
        }

        // åˆæœŸèª­ã¿è¾¼ã¿æ™‚ã«æ–°ã—ã„ç›£è¦–æ©Ÿèƒ½ã‚‚å®Ÿè¡Œ
        refreshServerLogs();
        refreshSystemResources();
        refreshMainSessions();

        // AIåˆ¶å¾¡ãƒ»æ‰‹å‹•è¿”ä¿¡æ©Ÿèƒ½
        function setAIMode(mode) {
            fetch('/api/main_ai_control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({mode: mode})
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${data.error}`);
                } else {
                    alert(data.message || `AIè‡ªå‹•å¿œç­”ã‚’${mode === 'on' ? 'ON' : 'OFF'}ã«ã—ã¾ã—ãŸ`);
                    refreshAIStatus();
                    refreshManualReplyQueue();
                }
            })
            .catch(error => {
                alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            });
        }

        function refreshAIStatus() {
            fetch('/api/main_ai_control')
                .then(res => res.json())
                .then(data => {
                    const statusElement = document.getElementById('ai-status');
                    const onBtn = document.getElementById('ai-on-btn');
                    const offBtn = document.getElementById('ai-off-btn');
                    
                    if (data.ai_auto_reply) {
                        statusElement.textContent = 'ğŸŸ¢ AIè‡ªå‹•å¿œç­”ON';
                        statusElement.style.color = '#28a745';
                        onBtn.disabled = true;
                        offBtn.disabled = false;
                    } else {
                        statusElement.textContent = 'ğŸ”´ AIè‡ªå‹•å¿œç­”OFF';
                        statusElement.style.color = '#dc3545';
                        onBtn.disabled = false;
                        offBtn.disabled = true;
                    }
                })
                .catch(error => {
                    document.getElementById('ai-status').textContent = 'âŒ çŠ¶æ…‹å–å¾—ã‚¨ãƒ©ãƒ¼';
                });
        }

        function refreshManualReplyQueue() {
            fetch('/api/main_manual_reply_queue')
                .then(res => res.json())
                .then(data => {
                    renderManualReplyQueue(data);
                    updateReplySessionSelect(data);
                })
                .catch(error => {
                    const content = document.getElementById('manual-reply-queue');
                    if (content) {
                        content.innerHTML = `<div class="test-error">ã‚­ãƒ¥ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    }
                });
        }

        function renderManualReplyQueue(queue) {
            const content = document.getElementById('manual-reply-queue');
            if (!content) {
                console.warn('manual-reply-queue element not found');
                return;
            }
            
            if (!Array.isArray(queue) || queue.length === 0) {
                content.innerHTML = '<div class="loading">æ‰‹å‹•è¿”ä¿¡å¾…ã¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            let html = '<table class="data-table"><tr><th>ã‚»ãƒƒã‚·ãƒ§ãƒ³ID</th><th>æ™‚åˆ»</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th></tr>';
            queue.forEach(item => {
                html += `<tr>
                    <td>${item.session_id || 'N/A'}</td>
                    <td>${item.timestamp || 'N/A'}</td>
                    <td>${item.user_message || 'N/A'}</td>
                    <td>${item.status || 'N/A'}</td>
                </tr>`;
            });
            html += '</table>';
            content.innerHTML = html;
        }

        function updateReplySessionSelect(queue) {
            const select = document.getElementById('reply-session-select');
            if (!select) return;
            
            // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆæœ€åˆã®ã€Œã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠã€ã¯æ®‹ã™ï¼‰
            select.innerHTML = '<option value="">ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠ</option>';
            
            if (Array.isArray(queue)) {
                queue.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.session_id;
                    option.textContent = `${item.session_id} - ${item.user_message.substring(0, 30)}...`;
                    select.appendChild(option);
                });
            }
        }

        function sendManualReply() {
            const sessionId = document.getElementById('reply-session-select').value;
            const message = document.getElementById('reply-message-input').value;
            
            if (!sessionId || !message) {
                alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            fetch('/api/main_manual_reply_queue', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: sessionId,
                    reply_message: message
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${data.error}`);
                } else {
                    alert(data.message || 'æ‰‹å‹•è¿”ä¿¡ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
                    document.getElementById('reply-message-input').value = '';
                    refreshManualReplyQueue();
                }
            })
            .catch(error => {
                alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            });
        }

        // åˆæœŸèª­ã¿è¾¼ã¿æ™‚ã«AIåˆ¶å¾¡æ©Ÿèƒ½ã‚‚å®Ÿè¡Œ
        refreshAIStatus();
        refreshManualReplyQueue();
    </script>
</body>
</html> 